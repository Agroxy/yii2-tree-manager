!function(e){"use strict";"function"==typeof define&&define.amd?define("jstree.dnd",["jquery","jstree"],e):"object"==typeof exports?e(require("jquery"),require("jstree")):e(jQuery,jQuery.jstree)}(function(e){"use strict";e.jstree.plugins.dnd||(e.jstree.defaults.dnd={copy:!0,open_timeout:500,is_draggable:!0,check_while_dragging:!0,always_copy:!1,inside_pos:0},e.jstree.plugins.dnd=function(t,a){this.bind=function(){a.bind.call(this),this.element.on("mousedown.jstree touchstart.jstree",".jstree-anchor",e.proxy(function(t){var a=this.get_node(t.target),n=this.is_selected(a)?this.get_selected().length:1;return a&&a.id&&"#"!==a.id&&(1===t.which||"touchstart"===t.type)&&(this.settings.dnd.is_draggable===!0||e.isFunction(this.settings.dnd.is_draggable)&&this.settings.dnd.is_draggable.call(this,n>1?this.get_selected(!0):[a]))?(this.element.trigger("mousedown.jstree"),e.vakata.dnd.start(t,{jstree:!0,origin:this,obj:this.get_node(a,!0),nodes:n>1?this.get_selected():[a.id]},'<div id="jstree-dnd" class="jstree-'+this.get_theme()+" jstree-"+this.get_theme()+"-"+this.get_theme_variant()+" "+(this.settings.core.themes.responsive?" jstree-dnd-responsive":"")+'"><i class="jstree-icon jstree-er"></i>'+(n>1?n+" "+this.get_string("nodes"):this.get_text(t.currentTarget,!0))+'<ins class="jstree-copy" style="display:none;">+</ins></div>')):void 0},this))}},e(function(){var t=!1,a=!1,n=!1,s=e('<div id="jstree-marker">&#160;</div>').hide();e(document).on("dnd_start.vakata.jstree",function(e,a){t=!1,a&&a.data&&a.data.jstree&&s.appendTo("body")}).on("dnd_move.vakata.jstree",function(r,i){if(n&&clearTimeout(n),i&&i.data&&i.data.jstree&&(!i.event.target.id||"jstree-marker"!==i.event.target.id)){var o,d,l,c,g,h,p,_,u,v,f,m,j,y,k=e.jstree.reference(i.event.target),w=!1,T=!1,x=!1;if(k&&k._data&&k._data.dnd)if(s.attr("class","jstree-"+k.get_theme()+(k.settings.core.themes.responsive?" jstree-dnd-responsive":"")),i.helper.children().attr("class","jstree-"+k.get_theme()+" jstree-"+k.get_theme()+"-"+k.get_theme_variant()+" "+(k.settings.core.themes.responsive?" jstree-dnd-responsive":"")).find(".jstree-copy").first()[i.data.origin&&(i.data.origin.settings.dnd.always_copy||i.data.origin.settings.dnd.copy&&(i.event.metaKey||i.event.ctrlKey))?"show":"hide"](),i.event.target!==k.element[0]&&i.event.target!==k.get_container_ul()[0]||0!==k.get_container_ul().children().length){if(w=e(i.event.target).closest(".jstree-anchor"),w&&w.length&&w.parent().is(".jstree-closed, .jstree-open, .jstree-leaf")&&(T=w.offset(),x=i.event.pageY-T.top,l=w.height(),h=l/3>x?["b","i","a"]:x>l-l/3?["a","i","b"]:x>l/2?["i","a","b"]:["i","b","a"],e.each(h,function(r,x){switch(x){case"b":o=T.left-6,d=T.top,c=k.get_parent(w),g=w.parent().index();break;case"i":j=k.settings.dnd.inside_pos,y=k.get_node(w.parent()),o=T.left-2,d=T.top+l/2+1,c=y.id,g="first"===j?0:"last"===j?y.children.length:Math.min(j,y.children.length);break;case"a":o=T.left-6,d=T.top+l,c=k.get_parent(w),g=w.parent().index()+1}for(p=!0,_=0,u=i.data.nodes.length;u>_;_++)if(v=i.data.origin&&(i.data.origin.settings.dnd.always_copy||i.data.origin.settings.dnd.copy&&(i.event.metaKey||i.event.ctrlKey))?"copy_node":"move_node",f=g,"move_node"===v&&"a"===x&&i.data.origin&&i.data.origin===k&&c===k.get_parent(i.data.nodes[_])&&(m=k.get_node(c),f>e.inArray(i.data.nodes[_],m.children)&&(f-=1)),p=p&&(k&&k.settings&&k.settings.dnd&&k.settings.dnd.check_while_dragging===!1||k.check(v,i.data.origin&&i.data.origin!==k?i.data.origin.get_node(i.data.nodes[_]):i.data.nodes[_],c,f,{dnd:!0,ref:k.get_node(w.parent()),pos:x,is_multi:i.data.origin&&i.data.origin!==k,is_foreign:!i.data.origin})),!p){k&&k.last_error&&(a=k.last_error());break}return"i"===x&&w.parent().is(".jstree-closed")&&k.settings.dnd.open_timeout&&(n=setTimeout(function(e,t){return function(){e.open_node(t)}}(k,w),k.settings.dnd.open_timeout)),p?(t={ins:k,par:c,pos:"i"!==x||"last"!==j||0!==g||k.is_loaded(y)?g:"last"},s.css({left:o+"px",top:d+"px"}).show(),i.helper.find(".jstree-icon").first().removeClass("jstree-er").addClass("jstree-ok"),a={},h=!0,!1):void 0}),h===!0))return}else{for(p=!0,_=0,u=i.data.nodes.length;u>_&&(p=p&&k.check(i.data.origin&&(i.data.origin.settings.dnd.always_copy||i.data.origin.settings.dnd.copy&&(i.event.metaKey||i.event.ctrlKey))?"copy_node":"move_node",i.data.origin&&i.data.origin!==k?i.data.origin.get_node(i.data.nodes[_]):i.data.nodes[_],"#","last",{dnd:!0,ref:k.get_node("#"),pos:"i",is_multi:i.data.origin&&i.data.origin!==k,is_foreign:!i.data.origin}),p);_++);if(p)return t={ins:k,par:"#",pos:"last"},s.hide(),void i.helper.find(".jstree-icon").first().removeClass("jstree-er").addClass("jstree-ok")}t=!1,i.helper.find(".jstree-icon").removeClass("jstree-ok").addClass("jstree-er"),s.hide()}}).on("dnd_scroll.vakata.jstree",function(e,a){a&&a.data&&a.data.jstree&&(s.hide(),t=!1,a.helper.find(".jstree-icon").first().removeClass("jstree-ok").addClass("jstree-er"))}).on("dnd_stop.vakata.jstree",function(r,i){if(n&&clearTimeout(n),i&&i.data&&i.data.jstree){s.hide().detach();var o,d,l=[];if(t){for(o=0,d=i.data.nodes.length;d>o;o++)l[o]=i.data.origin?i.data.origin.get_node(i.data.nodes[o]):i.data.nodes[o],i.data.origin&&(l[o].instance=i.data.origin);for(t.ins[i.data.origin&&(i.data.origin.settings.dnd.always_copy||i.data.origin.settings.dnd.copy&&(i.event.metaKey||i.event.ctrlKey))?"copy_node":"move_node"](l,t.par,t.pos),o=0,d=l.length;d>o;o++)l[o].instance&&(l[o].instance=null)}else o=e(i.event.target).closest(".jstree"),o.length&&a&&a.error&&"check"===a.error&&(o=o.jstree(!0),o&&o.settings.core.error.call(this,a))}}).on("keyup.jstree keydown.jstree",function(t,a){a=e.vakata.dnd._get(),a&&a.data&&a.data.jstree&&a.helper.find(".jstree-copy").first()[a.data.origin&&(a.data.origin.settings.dnd.always_copy||a.data.origin.settings.dnd.copy&&(t.metaKey||t.ctrlKey))?"show":"hide"]()})}),function(e){var t={element:!1,target:!1,is_down:!1,is_drag:!1,helper:!1,helper_w:0,data:!1,init_x:0,init_y:0,scroll_l:0,scroll_t:0,scroll_e:!1,scroll_i:!1,is_touch:!1};e.vakata.dnd={settings:{scroll_speed:10,scroll_proximity:20,helper_left:5,helper_top:10,threshold:5,threshold_touch:50},_trigger:function(t,a){var n=e.vakata.dnd._get();n.event=a,e(document).triggerHandler("dnd_"+t+".vakata",n)},_get:function(){return{data:t.data,element:t.element,helper:t.helper}},_clean:function(){t.helper&&t.helper.remove(),t.scroll_i&&(clearInterval(t.scroll_i),t.scroll_i=!1),t={element:!1,target:!1,is_down:!1,is_drag:!1,helper:!1,helper_w:0,data:!1,init_x:0,init_y:0,scroll_l:0,scroll_t:0,scroll_e:!1,scroll_i:!1,is_touch:!1},e(document).off("mousemove.vakata.jstree touchmove.vakata.jstree",e.vakata.dnd.drag),e(document).off("mouseup.vakata.jstree touchend.vakata.jstree",e.vakata.dnd.stop)},_scroll:function(a){if(!t.scroll_e||!t.scroll_l&&!t.scroll_t)return t.scroll_i&&(clearInterval(t.scroll_i),t.scroll_i=!1),!1;if(!t.scroll_i)return t.scroll_i=setInterval(e.vakata.dnd._scroll,100),!1;if(a===!0)return!1;var n=t.scroll_e.scrollTop(),s=t.scroll_e.scrollLeft();t.scroll_e.scrollTop(n+t.scroll_t*e.vakata.dnd.settings.scroll_speed),t.scroll_e.scrollLeft(s+t.scroll_l*e.vakata.dnd.settings.scroll_speed),(n!==t.scroll_e.scrollTop()||s!==t.scroll_e.scrollLeft())&&e.vakata.dnd._trigger("scroll",t.scroll_e)},start:function(a,n,s){"touchstart"===a.type&&a.originalEvent&&a.originalEvent.changedTouches&&a.originalEvent.changedTouches[0]&&(a.pageX=a.originalEvent.changedTouches[0].pageX,a.pageY=a.originalEvent.changedTouches[0].pageY,a.target=document.elementFromPoint(a.originalEvent.changedTouches[0].pageX-window.pageXOffset,a.originalEvent.changedTouches[0].pageY-window.pageYOffset)),t.is_drag&&e.vakata.dnd.stop({});try{a.currentTarget.unselectable="on",a.currentTarget.onselectstart=function(){return!1},a.currentTarget.style&&(a.currentTarget.style.MozUserSelect="none")}catch(r){}return t.init_x=a.pageX,t.init_y=a.pageY,t.data=n,t.is_down=!0,t.element=a.currentTarget,t.target=a.target,t.is_touch="touchstart"===a.type,s!==!1&&(t.helper=e("<div id='vakata-dnd'></div>").html(s).css({display:"block",margin:"0",padding:"0",position:"absolute",top:"-2000px",lineHeight:"16px",zIndex:"10000"})),e(document).on("mousemove.vakata.jstree touchmove.vakata.jstree",e.vakata.dnd.drag),e(document).on("mouseup.vakata.jstree touchend.vakata.jstree",e.vakata.dnd.stop),!1},drag:function(a){if("touchmove"===a.type&&a.originalEvent&&a.originalEvent.changedTouches&&a.originalEvent.changedTouches[0]&&(a.pageX=a.originalEvent.changedTouches[0].pageX,a.pageY=a.originalEvent.changedTouches[0].pageY,a.target=document.elementFromPoint(a.originalEvent.changedTouches[0].pageX-window.pageXOffset,a.originalEvent.changedTouches[0].pageY-window.pageYOffset)),t.is_down){if(!t.is_drag){if(!(Math.abs(a.pageX-t.init_x)>(t.is_touch?e.vakata.dnd.settings.threshold_touch:e.vakata.dnd.settings.threshold)||Math.abs(a.pageY-t.init_y)>(t.is_touch?e.vakata.dnd.settings.threshold_touch:e.vakata.dnd.settings.threshold)))return;t.helper&&(t.helper.appendTo("body"),t.helper_w=t.helper.outerWidth()),t.is_drag=!0,e.vakata.dnd._trigger("start",a)}var n=!1,s=!1,r=!1,i=!1,o=!1,d=!1,l=!1,c=!1,g=!1,h=!1;return t.scroll_t=0,t.scroll_l=0,t.scroll_e=!1,e(e(a.target).parentsUntil("body").addBack().get().reverse()).filter(function(){return/^auto|scroll$/.test(e(this).css("overflow"))&&(this.scrollHeight>this.offsetHeight||this.scrollWidth>this.offsetWidth)}).each(function(){var n=e(this),s=n.offset();return this.scrollHeight>this.offsetHeight&&(s.top+n.height()-a.pageY<e.vakata.dnd.settings.scroll_proximity&&(t.scroll_t=1),a.pageY-s.top<e.vakata.dnd.settings.scroll_proximity&&(t.scroll_t=-1)),this.scrollWidth>this.offsetWidth&&(s.left+n.width()-a.pageX<e.vakata.dnd.settings.scroll_proximity&&(t.scroll_l=1),a.pageX-s.left<e.vakata.dnd.settings.scroll_proximity&&(t.scroll_l=-1)),t.scroll_t||t.scroll_l?(t.scroll_e=e(this),!1):void 0}),t.scroll_e||(n=e(document),s=e(window),r=n.height(),i=s.height(),o=n.width(),d=s.width(),l=n.scrollTop(),c=n.scrollLeft(),r>i&&a.pageY-l<e.vakata.dnd.settings.scroll_proximity&&(t.scroll_t=-1),r>i&&i-(a.pageY-l)<e.vakata.dnd.settings.scroll_proximity&&(t.scroll_t=1),o>d&&a.pageX-c<e.vakata.dnd.settings.scroll_proximity&&(t.scroll_l=-1),o>d&&d-(a.pageX-c)<e.vakata.dnd.settings.scroll_proximity&&(t.scroll_l=1),(t.scroll_t||t.scroll_l)&&(t.scroll_e=n)),t.scroll_e&&e.vakata.dnd._scroll(!0),t.helper&&(g=parseInt(a.pageY+e.vakata.dnd.settings.helper_top,10),h=parseInt(a.pageX+e.vakata.dnd.settings.helper_left,10),r&&g+25>r&&(g=r-50),o&&h+t.helper_w>o&&(h=o-(t.helper_w+2)),t.helper.css({left:h+"px",top:g+"px"})),e.vakata.dnd._trigger("move",a),!1}},stop:function(a){if("touchend"===a.type&&a.originalEvent&&a.originalEvent.changedTouches&&a.originalEvent.changedTouches[0]&&(a.pageX=a.originalEvent.changedTouches[0].pageX,a.pageY=a.originalEvent.changedTouches[0].pageY,a.target=document.elementFromPoint(a.originalEvent.changedTouches[0].pageX-window.pageXOffset,a.originalEvent.changedTouches[0].pageY-window.pageYOffset)),t.is_drag)e.vakata.dnd._trigger("stop",a);else if("touchend"===a.type&&a.target===t.target){var n=setTimeout(function(){e(a.target).click()},100);e(a.target).one("click",function(){n&&clearTimeout(n)})}return e.vakata.dnd._clean(),!1}}}(e))});