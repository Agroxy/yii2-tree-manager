!function(e){"use strict";"function"==typeof define&&define.amd?define("jstree.types",["jquery","jstree"],e):"object"==typeof exports?e(require("jquery"),require("jstree")):e(jQuery,jQuery.jstree)}(function(e,t,i){"use strict";e.jstree.plugins.types||(e.jstree.defaults.types={"#":{},"default":{}},e.jstree.plugins.types=function(t,r){this.init=function(e,t){var d,n;if(t&&t.types&&t.types["default"])for(d in t.types)if("default"!==d&&"#"!==d&&t.types.hasOwnProperty(d))for(n in t.types["default"])t.types["default"].hasOwnProperty(n)&&t.types[d][n]===i&&(t.types[d][n]=t.types["default"][n]);r.init.call(this,e,t),this._model.data["#"].type="#"},this.refresh=function(e,t){r.refresh.call(this,e,t),this._model.data["#"].type="#"},this.bind=function(){this.element.on("model.jstree",e.proxy(function(e,t){var r,d,n=this._model.data,s=t.nodes,a=this.settings.types,l="default";for(r=0,d=s.length;d>r;r++)l="default",n[s[r]].original&&n[s[r]].original.type&&a[n[s[r]].original.type]&&(l=n[s[r]].original.type),n[s[r]].data&&n[s[r]].data.jstree&&n[s[r]].data.jstree.type&&a[n[s[r]].data.jstree.type]&&(l=n[s[r]].data.jstree.type),n[s[r]].type=l,n[s[r]].icon===!0&&a[l].icon!==i&&(n[s[r]].icon=a[l].icon);n["#"].type="#"},this)),r.bind.call(this)},this.get_json=function(t,i,d){var n,s,a=this._model.data,l=i?e.extend(!0,{},i,{no_id:!1}):{},o=r.get_json.call(this,t,l,d);if(o===!1)return!1;if(e.isArray(o))for(n=0,s=o.length;s>n;n++)o[n].type=o[n].id&&a[o[n].id]&&a[o[n].id].type?a[o[n].id].type:"default",i&&i.no_id&&(delete o[n].id,o[n].li_attr&&o[n].li_attr.id&&delete o[n].li_attr.id,o[n].a_attr&&o[n].a_attr.id&&delete o[n].a_attr.id);else o.type=o.id&&a[o.id]&&a[o.id].type?a[o.id].type:"default",i&&i.no_id&&(o=this._delete_ids(o));return o},this._delete_ids=function(t){if(e.isArray(t)){for(var i=0,r=t.length;r>i;i++)t[i]=this._delete_ids(t[i]);return t}return delete t.id,t.li_attr&&t.li_attr.id&&delete t.li_attr.id,t.a_attr&&t.a_attr.id&&delete t.a_attr.id,t.children&&e.isArray(t.children)&&(t.children=this._delete_ids(t.children)),t},this.check=function(t,d,n,s,a){if(r.check.call(this,t,d,n,s,a)===!1)return!1;d=d&&d.id?d:this.get_node(d),n=n&&n.id?n:this.get_node(n);var l,o,h,_,c=d&&d.id?e.jstree.reference(d.id):null;switch(c=c&&c._model&&c._model.data?c._model.data:null,t){case"create_node":case"move_node":case"copy_node":if("move_node"!==t||-1===e.inArray(d.id,n.children)){if(l=this.get_rules(n),l.max_children!==i&&-1!==l.max_children&&l.max_children===n.children.length)return this._data.core.last_error={error:"check",plugin:"types",id:"types_01",reason:"max_children prevents function: "+t,data:JSON.stringify({chk:t,pos:s,obj:d&&d.id?d.id:!1,par:n&&n.id?n.id:!1})},!1;if(l.valid_children!==i&&-1!==l.valid_children&&-1===e.inArray(d.type||"default",l.valid_children))return this._data.core.last_error={error:"check",plugin:"types",id:"types_02",reason:"valid_children prevents function: "+t,data:JSON.stringify({chk:t,pos:s,obj:d&&d.id?d.id:!1,par:n&&n.id?n.id:!1})},!1;if(c&&d.children_d&&d.parents){for(o=0,h=0,_=d.children_d.length;_>h;h++)o=Math.max(o,c[d.children_d[h]].parents.length);o=o-d.parents.length+1}(0>=o||o===i)&&(o=1);do{if(l.max_depth!==i&&-1!==l.max_depth&&l.max_depth<o)return this._data.core.last_error={error:"check",plugin:"types",id:"types_03",reason:"max_depth prevents function: "+t,data:JSON.stringify({chk:t,pos:s,obj:d&&d.id?d.id:!1,par:n&&n.id?n.id:!1})},!1;n=this.get_node(n.parent),l=this.get_rules(n),o++}while(n)}}return!0},this.get_rules=function(e){if(e=this.get_node(e),!e)return!1;var t=this.get_type(e,!0);return t.max_depth===i&&(t.max_depth=-1),t.max_children===i&&(t.max_children=-1),t.valid_children===i&&(t.valid_children=-1),t},this.get_type=function(t,i){return t=this.get_node(t),t?i?e.extend({type:t.type},this.settings.types[t.type]):t.type:!1},this.set_type=function(t,r){var d,n,s,a,l;if(e.isArray(t)){for(t=t.slice(),n=0,s=t.length;s>n;n++)this.set_type(t[n],r);return!0}return d=this.settings.types,t=this.get_node(t),d[r]&&t?(a=t.type,l=this.get_icon(t),t.type=r,(l===!0||d[a]&&d[a].icon!==i&&l===d[a].icon)&&this.set_icon(t,d[r].icon!==i?d[r].icon:!0),!0):!1}})});