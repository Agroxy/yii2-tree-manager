!function(e){"use strict";"function"==typeof define&&define.amd?define("jstree.checkbox",["jquery","jstree"],e):"object"==typeof exports?e(require("jquery"),require("jstree")):e(jQuery,jQuery.jstree)}(function(e){"use strict";if(!e.jstree.plugins.checkbox){var t=document.createElement("I");t.className="jstree-icon jstree-checkbox",t.setAttribute("role","presentation"),e.jstree.defaults.checkbox={visible:!0,three_state:!0,whole_node:!0,keep_selected_style:!0,cascade:"",tie_selection:!0},e.jstree.plugins.checkbox=function(c,s){this.bind=function(){s.bind.call(this),this._data.checkbox.uto=!1,this._data.checkbox.selected=[],this.settings.checkbox.three_state&&(this.settings.checkbox.cascade="up+down+undetermined"),this.element.on("init.jstree",e.proxy(function(){this._data.checkbox.visible=this.settings.checkbox.visible,this.settings.checkbox.keep_selected_style||this.element.addClass("jstree-checkbox-no-clicked"),this.settings.checkbox.tie_selection&&this.element.addClass("jstree-checkbox-selection")},this)).on("loading.jstree",e.proxy(function(){this[this._data.checkbox.visible?"show_checkboxes":"hide_checkboxes"]()},this)),-1!==this.settings.checkbox.cascade.indexOf("undetermined")&&this.element.on("changed.jstree uncheck_node.jstree check_node.jstree uncheck_all.jstree check_all.jstree move_node.jstree copy_node.jstree redraw.jstree open_node.jstree",e.proxy(function(){this._data.checkbox.uto&&clearTimeout(this._data.checkbox.uto),this._data.checkbox.uto=setTimeout(e.proxy(this._undetermined,this),50)},this)),this.settings.checkbox.tie_selection||this.element.on("model.jstree",e.proxy(function(e,t){var c,s,i=this._model.data,d=(i[t.parent],t.nodes);for(c=0,s=d.length;s>c;c++)i[d[c]].state.checked=i[d[c]].original&&i[d[c]].original.state&&i[d[c]].original.state.checked,i[d[c]].state.checked&&this._data.checkbox.selected.push(d[c])},this)),(-1!==this.settings.checkbox.cascade.indexOf("up")||-1!==this.settings.checkbox.cascade.indexOf("down"))&&this.element.on("model.jstree",e.proxy(function(t,c){var s,i,d,n,h,a,o=this._model.data,r=o[c.parent],l=c.nodes,_=[],k=this.settings.checkbox.cascade,g=this.settings.checkbox.tie_selection;if(-1!==k.indexOf("down"))if(r.state[g?"selected":"checked"]){for(i=0,d=l.length;d>i;i++)o[l[i]].state[g?"selected":"checked"]=!0;this._data[g?"core":"checkbox"].selected=this._data[g?"core":"checkbox"].selected.concat(l)}else for(i=0,d=l.length;d>i;i++)if(o[l[i]].state[g?"selected":"checked"]){for(n=0,h=o[l[i]].children_d.length;h>n;n++)o[o[l[i]].children_d[n]].state[g?"selected":"checked"]=!0;this._data[g?"core":"checkbox"].selected=this._data[g?"core":"checkbox"].selected.concat(o[l[i]].children_d)}if(-1!==k.indexOf("up")){for(i=0,d=r.children_d.length;d>i;i++)o[r.children_d[i]].children.length||_.push(o[r.children_d[i]].parent);for(_=e.vakata.array_unique(_),n=0,h=_.length;h>n;n++)for(r=o[_[n]];r&&"#"!==r.id;){for(s=0,i=0,d=r.children.length;d>i;i++)s+=o[r.children[i]].state[g?"selected":"checked"];if(s!==d)break;r.state[g?"selected":"checked"]=!0,this._data[g?"core":"checkbox"].selected.push(r.id),a=this.get_node(r,!0),a&&a.length&&a.attr("aria-selected",!0).children(".jstree-anchor").addClass(g?"jstree-clicked":"jstree-checked"),r=this.get_node(r.parent)}}this._data[g?"core":"checkbox"].selected=e.vakata.array_unique(this._data[g?"core":"checkbox"].selected)},this)).on(this.settings.checkbox.tie_selection?"select_node.jstree":"check_node.jstree",e.proxy(function(t,c){var s,i,d,n,h=c.node,a=this._model.data,o=this.get_node(h.parent),r=this.get_node(h,!0),l=this.settings.checkbox.cascade,_=this.settings.checkbox.tie_selection;if(-1!==l.indexOf("down"))for(this._data[_?"core":"checkbox"].selected=e.vakata.array_unique(this._data[_?"core":"checkbox"].selected.concat(h.children_d)),s=0,i=h.children_d.length;i>s;s++)n=a[h.children_d[s]],n.state[_?"selected":"checked"]=!0,n&&n.original&&n.original.state&&n.original.state.undetermined&&(n.original.state.undetermined=!1);if(-1!==l.indexOf("up"))for(;o&&"#"!==o.id;){for(d=0,s=0,i=o.children.length;i>s;s++)d+=a[o.children[s]].state[_?"selected":"checked"];if(d!==i)break;o.state[_?"selected":"checked"]=!0,this._data[_?"core":"checkbox"].selected.push(o.id),n=this.get_node(o,!0),n&&n.length&&n.attr("aria-selected",!0).children(".jstree-anchor").addClass(_?"jstree-clicked":"jstree-checked"),o=this.get_node(o.parent)}-1!==l.indexOf("down")&&r.length&&r.find(".jstree-anchor").addClass(_?"jstree-clicked":"jstree-checked").parent().attr("aria-selected",!0)},this)).on(this.settings.checkbox.tie_selection?"deselect_all.jstree":"uncheck_all.jstree",e.proxy(function(){var e,t,c,s=this.get_node("#"),i=this._model.data;for(e=0,t=s.children_d.length;t>e;e++)c=i[s.children_d[e]],c&&c.original&&c.original.state&&c.original.state.undetermined&&(c.original.state.undetermined=!1)},this)).on(this.settings.checkbox.tie_selection?"deselect_node.jstree":"uncheck_node.jstree",e.proxy(function(t,c){var s,i,d,n=c.node,h=this.get_node(n,!0),a=this.settings.checkbox.cascade,o=this.settings.checkbox.tie_selection;if(n&&n.original&&n.original.state&&n.original.state.undetermined&&(n.original.state.undetermined=!1),-1!==a.indexOf("down"))for(s=0,i=n.children_d.length;i>s;s++)d=this._model.data[n.children_d[s]],d.state[o?"selected":"checked"]=!1,d&&d.original&&d.original.state&&d.original.state.undetermined&&(d.original.state.undetermined=!1);if(-1!==a.indexOf("up"))for(s=0,i=n.parents.length;i>s;s++)d=this._model.data[n.parents[s]],d.state[o?"selected":"checked"]=!1,d&&d.original&&d.original.state&&d.original.state.undetermined&&(d.original.state.undetermined=!1),d=this.get_node(n.parents[s],!0),d&&d.length&&d.attr("aria-selected",!1).children(".jstree-anchor").removeClass(o?"jstree-clicked":"jstree-checked");for(d=[],s=0,i=this._data[o?"core":"checkbox"].selected.length;i>s;s++)-1!==a.indexOf("down")&&-1!==e.inArray(this._data[o?"core":"checkbox"].selected[s],n.children_d)||-1!==a.indexOf("up")&&-1!==e.inArray(this._data[o?"core":"checkbox"].selected[s],n.parents)||d.push(this._data[o?"core":"checkbox"].selected[s]);this._data[o?"core":"checkbox"].selected=e.vakata.array_unique(d),-1!==a.indexOf("down")&&h.length&&h.find(".jstree-anchor").removeClass(o?"jstree-clicked":"jstree-checked").parent().attr("aria-selected",!1)},this)),-1!==this.settings.checkbox.cascade.indexOf("up")&&this.element.on("delete_node.jstree",e.proxy(function(e,t){for(var c,s,i,d,n=this.get_node(t.parent),h=this._model.data,a=this.settings.checkbox.tie_selection;n&&"#"!==n.id;){for(i=0,c=0,s=n.children.length;s>c;c++)i+=h[n.children[c]].state[a?"selected":"checked"];if(i!==s)break;n.state[a?"selected":"checked"]=!0,this._data[a?"core":"checkbox"].selected.push(n.id),d=this.get_node(n,!0),d&&d.length&&d.attr("aria-selected",!0).children(".jstree-anchor").addClass(a?"jstree-clicked":"jstree-checked"),n=this.get_node(n.parent)}},this)).on("move_node.jstree",e.proxy(function(t,c){var s,i,d,n,h,a=c.is_multi,o=c.old_parent,r=this.get_node(c.parent),l=this._model.data,_=this.settings.checkbox.tie_selection;if(!a)for(s=this.get_node(o);s&&"#"!==s.id;){for(i=0,d=0,n=s.children.length;n>d;d++)i+=l[s.children[d]].state[_?"selected":"checked"];if(i!==n)break;s.state[_?"selected":"checked"]=!0,this._data[_?"core":"checkbox"].selected.push(s.id),h=this.get_node(s,!0),h&&h.length&&h.attr("aria-selected",!0).children(".jstree-anchor").addClass(_?"jstree-clicked":"jstree-checked"),s=this.get_node(s.parent)}for(s=r;s&&"#"!==s.id;){for(i=0,d=0,n=s.children.length;n>d;d++)i+=l[s.children[d]].state[_?"selected":"checked"];if(i===n)s.state[_?"selected":"checked"]||(s.state[_?"selected":"checked"]=!0,this._data[_?"core":"checkbox"].selected.push(s.id),h=this.get_node(s,!0),h&&h.length&&h.attr("aria-selected",!0).children(".jstree-anchor").addClass(_?"jstree-clicked":"jstree-checked"));else{if(!s.state[_?"selected":"checked"])break;s.state[_?"selected":"checked"]=!1,this._data[_?"core":"checkbox"].selected=e.vakata.array_remove_item(this._data[_?"core":"checkbox"].selected,s.id),h=this.get_node(s,!0),h&&h.length&&h.attr("aria-selected",!1).children(".jstree-anchor").removeClass(_?"jstree-clicked":"jstree-checked")}s=this.get_node(s.parent)}},this))},this._undetermined=function(){var t,c,s=this._model.data,i=this.settings.checkbox.tie_selection,d=this._data[i?"core":"checkbox"].selected,n=[],h=this;for(t=0,c=d.length;c>t;t++)s[d[t]]&&s[d[t]].parents&&(n=n.concat(s[d[t]].parents));for(this.element.find(".jstree-closed").not(":has(.jstree-children)").each(function(){var e,i=h.get_node(this);if(i.state.loaded)for(t=0,c=i.children_d.length;c>t;t++)e=s[i.children_d[t]],!e.state.loaded&&e.original&&e.original.state&&e.original.state.undetermined&&e.original.state.undetermined===!0&&(n.push(e.id),n=n.concat(e.parents));else i.original&&i.original.state&&i.original.state.undetermined&&i.original.state.undetermined===!0&&(n.push(i.id),n=n.concat(i.parents))}),n=e.vakata.array_unique(n),n=e.vakata.array_remove_item(n,"#"),this.element.find(".jstree-undetermined").removeClass("jstree-undetermined"),t=0,c=n.length;c>t;t++)s[n[t]].state[i?"selected":"checked"]||(d=this.get_node(n[t],!0),d&&d.length&&d.children(".jstree-anchor").children(".jstree-checkbox").addClass("jstree-undetermined"))},this.redraw_node=function(c,i,d){if(c=s.redraw_node.apply(this,arguments)){var n,h,a=null;for(n=0,h=c.childNodes.length;h>n;n++)if(c.childNodes[n]&&c.childNodes[n].className&&-1!==c.childNodes[n].className.indexOf("jstree-anchor")){a=c.childNodes[n];break}a&&(!this.settings.checkbox.tie_selection&&this._model.data[c.id].state.checked&&(a.className+=" jstree-checked"),a.insertBefore(t.cloneNode(!1),a.childNodes[0]))}return d||-1===this.settings.checkbox.cascade.indexOf("undetermined")||(this._data.checkbox.uto&&clearTimeout(this._data.checkbox.uto),this._data.checkbox.uto=setTimeout(e.proxy(this._undetermined,this),50)),c},this.show_checkboxes=function(){this._data.core.themes.checkboxes=!0,this.get_container_ul().removeClass("jstree-no-checkboxes")},this.hide_checkboxes=function(){this._data.core.themes.checkboxes=!1,this.get_container_ul().addClass("jstree-no-checkboxes")},this.toggle_checkboxes=function(){this._data.core.themes.checkboxes?this.hide_checkboxes():this.show_checkboxes()},this.is_undetermined=function(t){t=this.get_node(t);var c,s,i=this.settings.checkbox.cascade,d=this.settings.checkbox.tie_selection,n=this._data[d?"core":"checkbox"].selected,h=this._model.data;if(!t||t.state[d?"selected":"checked"]===!0||-1===i.indexOf("undetermined")||-1===i.indexOf("down")&&-1===i.indexOf("up"))return!1;if(!t.state.loaded&&t.original.state.undetermined===!0)return!0;for(c=0,s=t.children_d.length;s>c;c++)if(-1!==e.inArray(t.children_d[c],n)||!h[t.children_d[c]].state.loaded&&h[t.children_d[c]].original.state.undetermined)return!0;return!1},this.activate_node=function(t,c){return this.settings.checkbox.tie_selection&&(this.settings.checkbox.whole_node||e(c.target).hasClass("jstree-checkbox"))&&(c.ctrlKey=!0),this.settings.checkbox.tie_selection||!this.settings.checkbox.whole_node&&!e(c.target).hasClass("jstree-checkbox")?s.activate_node.call(this,t,c):(this.is_checked(t)?this.uncheck_node(t,c):this.check_node(t,c),void this.trigger("activate_node",{node:this.get_node(t)}))},this.check_node=function(t,c){if(this.settings.checkbox.tie_selection)return this.select_node(t,!1,!0,c);var s,i,d;if(e.isArray(t)){for(t=t.slice(),i=0,d=t.length;d>i;i++)this.check_node(t[i],c);return!0}return t=this.get_node(t),t&&"#"!==t.id?(s=this.get_node(t,!0),void(t.state.checked||(t.state.checked=!0,this._data.checkbox.selected.push(t.id),s&&s.length&&s.children(".jstree-anchor").addClass("jstree-checked"),this.trigger("check_node",{node:t,selected:this._data.checkbox.selected,event:c})))):!1},this.uncheck_node=function(t,c){if(this.settings.checkbox.tie_selection)return this.deselect_node(t,!1,c);var s,i,d;if(e.isArray(t)){for(t=t.slice(),s=0,i=t.length;i>s;s++)this.uncheck_node(t[s],c);return!0}return t=this.get_node(t),t&&"#"!==t.id?(d=this.get_node(t,!0),void(t.state.checked&&(t.state.checked=!1,this._data.checkbox.selected=e.vakata.array_remove_item(this._data.checkbox.selected,t.id),d.length&&d.children(".jstree-anchor").removeClass("jstree-checked"),this.trigger("uncheck_node",{node:t,selected:this._data.checkbox.selected,event:c})))):!1},this.check_all=function(){if(this.settings.checkbox.tie_selection)return this.select_all();{var e,t;this._data.checkbox.selected.concat([])}for(this._data.checkbox.selected=this._model.data["#"].children_d.concat(),e=0,t=this._data.checkbox.selected.length;t>e;e++)this._model.data[this._data.checkbox.selected[e]]&&(this._model.data[this._data.checkbox.selected[e]].state.checked=!0);this.redraw(!0),this.trigger("check_all",{selected:this._data.checkbox.selected})},this.uncheck_all=function(){if(this.settings.checkbox.tie_selection)return this.deselect_all();var e,t,c=this._data.checkbox.selected.concat([]);for(e=0,t=this._data.checkbox.selected.length;t>e;e++)this._model.data[this._data.checkbox.selected[e]]&&(this._model.data[this._data.checkbox.selected[e]].state.checked=!1);this._data.checkbox.selected=[],this.element.find(".jstree-checked").removeClass("jstree-checked"),this.trigger("uncheck_all",{selected:this._data.checkbox.selected,node:c})},this.is_checked=function(e){return this.settings.checkbox.tie_selection?this.is_selected(e):(e=this.get_node(e),e&&"#"!==e.id?e.state.checked:!1)},this.get_checked=function(t){return this.settings.checkbox.tie_selection?this.get_selected(t):t?e.map(this._data.checkbox.selected,e.proxy(function(e){return this.get_node(e)},this)):this._data.checkbox.selected},this.get_top_checked=function(t){if(this.settings.checkbox.tie_selection)return this.get_top_selected(t);var c,s,i,d,n=this.get_checked(!0),h={};for(c=0,s=n.length;s>c;c++)h[n[c].id]=n[c];for(c=0,s=n.length;s>c;c++)for(i=0,d=n[c].children_d.length;d>i;i++)h[n[c].children_d[i]]&&delete h[n[c].children_d[i]];n=[];for(c in h)h.hasOwnProperty(c)&&n.push(c);return t?e.map(n,e.proxy(function(e){return this.get_node(e)},this)):n},this.get_bottom_checked=function(t){if(this.settings.checkbox.tie_selection)return this.get_bottom_selected(t);var c,s,i=this.get_checked(!0),d=[];for(c=0,s=i.length;s>c;c++)i[c].children.length||d.push(i[c].id);return t?e.map(d,e.proxy(function(e){return this.get_node(e)},this)):d}}}});